<!DOCTYPE html>
<html lang="en">
<head>
	<title>xi4n:livemap.js</title>
	<link rel="stylesheet" href="/static/css/screen.css" type="text/css">

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	<script src="/static/js/d3.min.js" type="text/javascript"></script>
	<script src="/static/js/livemap.js" type="text/javascript"></script>
	<script src="/static/js/chosen.jquery.min.js" type="text/javascript"></script>

	<script src="/socket.io/socket.io.js"></script>

	<script type="text/javascript">
		$(document).ready(function()
		{
			var track = new LiveMap();
			track.dst = '#container-inner-track';
			track.basePath = '/static/pth/';

			track.on('pth', function()
			{
				track.drawTrack();
			});

			track.on('addplyr', function(plid)
			{
				var plyr = track.getPlyr(plid);

				if ($('#tracker-table tbody tr.' + plid).length <= 0)
				{
					$('<tr class="' + plid + ' plyr"> \
							<td class="pos">' + plyr.pos + '</th> \
							<td class="name">' + plyr.name + '</td> \
							<td class="vehicle">' + plyr.vehicle + '</td> \
						</tr>').data('plid', plid).appendTo('#tracker-table tbody');
					return;
				}
				else
				{
					var row = $('#tracker-table tbody tr.' + plid);
					row.find('td.name').text(plyr.name);
					row.find('td.vehicle').text(plyr.vehicle);
				}
			});

			track.on(['remplyr', 'clearplyr'], function(plid)
			{
				$('#tracker-table tbody tr.' + plid).remove();
			});

			track.on('drawplyr', function(plid)
			{
				if ($('#tracker-table tbody tr.' + plid).length <= 0)
					track.emit('addplyr', plid);

				var plyr = track.getPlyr(plid);

				var row = $('#tracker-table tbody tr.' + plid);
					row.find('td.pos').text(plyr.pos);

				if (plyr.pos > 0)
					row.insertBefore('#tracker-table tbody tr:eq(' + plyr.pos + ')');
			});

			var servers = {};

			var socket = io.connect('http://localhost:<%= port.toString() %>');

		//	$(".chzn-select").chosen({ allow_single_deselect: true });

			$('#option-chat').change(function()
			{
				$('#container-chat').fadeToggle('slow');
			});

			$('#option-track').change(function()
			{
				$('#container-track').fadeToggle('slow');
			});

			$('#tracker-table tbody').on({
				mouseenter: function()
				{
					var plid = $(this).data('plid');
					track.highlightPlyr(plid);
				},
				mouseleave: function()
				{
					var plid = $(this).data('plid');
					track.unhighlightPlyr(plid);
				}
			},
			'tr.plyr');

			$('#option-fancy').change(function()
			{
				if ($(this).is(':checked'))
				{
					track.fancy = 1000;
					return;
				}

				track.fancy = 0;
			});

			$('#option-server').change(function()
			{
				var val = $(this).val();

				if ((val.length <= 0) || (val <= 0))
				{
					track.clear();
					socket.emit('leave');
					return;
				}

				var trackname = servers[val].track + '.json';
				track.loadPth(trackname);

				socket.emit('switch', val);
			});

			// update list of servers
			socket.on('maps', function(data)
			{
				var select = $('#option-server');
				var curr = select.val();

				for (var i in data)
				{
					if (!servers[i])
					{
						servers[i] = data[i];
						continue;
					}

					for(var j in data[i])
					{
						// special case
						if (j == 'track')
						{
							servers[i].track = data[i].track.replace(/[XY]$/i, '');

							if ((i == curr) && (track.pth) && 
								(track.pth.data.track != servers[i].track))
							{
								console.log('new track detected, loading');
								track.loadPth(servers[i].track + '.json');
							}

							continue;
						}

						servers[i][j] = servers[i][j];
					}
				}
	
				select.find('option[value!=]').remove();

				for(var i in data)
					$('<option value="' + i + '"' + ((i == curr) ?
							'selected="selected"' : '') + '>' + data[i].hostname + '</option>')
						.appendTo('#option-server');

				select.trigger("liszt:updated");
			});

			// positioning update
			socket.on('IS_MCI', function (data)
			{
				for(var i in data)
					track.drawPlyr(data[i].plid, data[i].x, data[i].y,
						data[i].position);
			});

			// player leaves
			socket.on('IS_PLL', function (data)
			{
				track.remPlyr(data);
			});

			// player putting
			socket.on('IS_PLP', function (data)
			{
				track.remPlyr(data);
			});

			// new player/unpitting
			socket.on('IS_NPL', function (data)
			{
				if ((data != null) && (data != undefined))
					track.addPlyr(data.plid, data.pname, data.cname);
			});

			// player chat
			socket.on('IS_MSO', function (data)
			{
				var name = (data.usertype == 0) ? 'System' : 'NonPlayer';

				if (data.plid > 0)
				{
					name = 'unknown';
					var plyr = track.getPlyr(data.plid);
					if (plyr)
						name = plyr.name;
				}	

				var d = new Date;
				$('#container-chat').prepend(
					$('<div class="container-chat-line"> \
					<span class="datetime">' + d.toISOString() + '</span> \
					<span class="chatter">' + name + '</span> \
					- ' + data.msg + ' \
					</div>').fadeIn('slow')
				);
			
				$('#container-chat .container-chat-line:gt(5)').fadeOut('slow');
			});
		});
	</script>
</head>
<body>
	<div id="container">
		<div id="container-menu">
			<span class="title">xi4n:livemap.js </span>

			<span class="options">

				<span class="option-track">
					<label for="option-track">
						<input type="checkbox" id="option-track"
						checked="checked"> Track
					</label>
				</span>

				<span class="option-fancy">
					<label for="option-fancy">
						<input type="checkbox" id="option-fancy"
						checked="checked"> Smooth
					</label>
				</span>

				<span class="option-chat">
					<label for="option-chat">
						<input type="checkbox" id="option-chat"
						checked="checked"> Chat
					</label>
				</span>

				<span class="option-servers">
					<select id="option-server" class="chzn-select"
						data-placeholder="Pick a Server...">
						<option value=""></option>
						<option value="1">asdsd</option>
					</select>
				</span>

			</span>
		</div>

		<div id="container-inner">
			<div id="container-tracker">

				<table class="tracker-table" id="tracker-table">
					<thead>
						<tr>
							<th class="pos">#</th>
							<th class="racer">Racer</th>
							<th class="vehicle">Vehicle</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>

			</div>

			<div id="container-track">
				<div id="container-inner-track">
				</div>
			</div>

		</div>

		<div id="container-chat">
		</div>
	</div>
</body>
</html>

