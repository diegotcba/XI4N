<!DOCTYPE html>
<html lang="en">
<head>
	<title>xi4n:livemap.js</title>
	<link rel="stylesheet" href="/static/css/screen.css" type="text/css">

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	<script src="/static/js/d3.min.js" type="text/javascript"></script>
	<script src="/static/js/livemap.js" type="text/javascript"></script>
	<script src="/static/js/chosen.jquery.min.js" type="text/javascript"></script>

	<script src="/socket.io/socket.io.js"></script>

	<script type="text/javascript">
		$(document).ready(function()
		{
			var track = new LiveMap();
			track.dst = '#container-inner-track';
			track.basePath = '/static/pth/';

			track.on('pth', function()
			{
				track.drawTrack();
			});

			var servers = {};

			var socket = io.connect('http://localhost:<%= port.toString() %>');

			$(".chzn-select").chosen({ allow_single_deselect: true });

			$('#option-chat').change(function()
			{
				$('#container-chat').fadeToggle('slow');
			});

			$('#option-track').change(function()
			{
				$('#container-track').fadeToggle('slow');
			});

			$('#option-fancy').change(function()
			{
				if ($(this).is(':checked'))
				{
					track.fancy = 1000;
					return;
				}

				track.fancy = 0;
			});

			$('#option-server').change(function()
			{
				var val = $(this).val();

				if ((val.length <= 0) || (val <= 0))
				{
					track.clear();
					socket.emit('leave');
					return;
				}

				var trackname = servers[val].track + '.json';
				track.loadPth(trackname);

				socket.emit('switch', val);
			});

			// update list of servers
			socket.on('maps', function(data)
			{
				var select = $('#option-server');
				var curr = select.val();

				for (var i in data)
				{
					if (!servers[i])
					{
						servers[i] = data[i];
						continue;
					}

					for(var j in data[i])
						servers[i][j] = (j == 'track') ? servers[i][j].replace(/[XY]$/i, '') : servers[i][j];
				}
	
				select.find('option[value!=]').remove();

				for(var i in data)
					$('<option value="' + i + '"' + ((i == curr) ?
							'selected="selected"' : '') + '>' + data[i].hostname + '</option>')
						.appendTo('#option-server');

				select.trigger("liszt:updated");

				if (curr > 0)
				{
					if (!data[curr])
						track.clear();

					if ((data[curr]) && (data[curr].track != track.pth.data.track))
						track.loadPth(data[curr].track);
				}
			});

			// positioning update
			socket.on('IS_MCI', function (data)
			{
				for(var i in data)
					track.drawPlyr(data[i].plid, data[i].x, data[i].y);
			});

			// player pits
			socket.on('IS_PLL', function (data)
			{
				track.remPlyr(data);
			});

			// player chat
			socket.on('IS_MSO', function (data)
			{
				var d = new Date;
				$('#container-chat').append('<div class="container-chat-line"> \
					<span class="datetime">' + d.toLocaleString() + '</span> \
					<span class="chatter">' + data.plid + '</span> \
					- ' + data.msg + ' \
				</div>');
			});
		});
	</script>
</head>
<body>
	<div id="container">
		<div id="container-menu">
			<span class="title">xi4n:livemap.js </span>

			<span class="options">

				<span class="option-track">
					<label for="option-track">
						<input type="checkbox" id="option-track"
						checked="checked"> Track
					</label>
				</span>

				<span class="option-fancy">
					<label for="option-fancy">
						<input type="checkbox" id="option-fancy"
						checked="checked"> Smooth
					</label>
				</span>

				<span class="option-chat">
					<label for="option-chat">
						<input type="checkbox" id="option-chat"
						checked="checked"> Chat
					</label>
				</span>

				<span class="option-servers">
					<select id="option-server" class="chzn-select"
						data-placeholder="Pick a Server...">
						<option value=""></option>
						<option value="1">asdsd</option>
					</select>
				</span>

			</span>
		</div>

		<div id="container-inner">
			<div id="container-tracker">

				<table class="tracker-table">
					<thead>
						<tr>
							<th class="pos">#</th>
							<th class="racer">Racer</th>
							<th class="vehicle">Vehicle</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>1</th>
							<th>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</th>
							<th>FZ50</th>
						</tr>
						<tr>
							<th>2</th>
							<th>Racer2</th>
							<th>LX6</th>
						</tr>
					</tbody>
				</table>

			</div>

			<div id="container-track">
				<div id="container-inner-track" style="height: 768px;">
				</div>
			</div>

		</div>

		<div id="container-chat">
		</div>
	</div>
</body>
</html>

