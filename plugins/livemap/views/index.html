<html>
	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript" src="/static/js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="/static/js/jquery-ui-1.8.17.custom.min.js"></script>
		<script type="text/javascript" src="/static/js/d3.min.js"></script>
		<link rel="stylesheet" href="/static/css/jquery-ui-1.8.17.custom.css" type="text/css" media="screen">
		<style>
			.track
			{
				stroke: #ccc;
				stroke-width: 10; 
				fill: none;
			}
			.title
			{
				font-family: Arial, Helvetica, sans-serif;
				font-size: 0.75em;
				color: #ccc;
			}
			.player
			{
				stroke: #fff;
				stroke-width: 2; 
				fill: brown;
			}
			#graph 
			{
				width:100px;
				height:768px;
				border:1px solid #ccc;

				margin-left: auto;
				margin-right:auto;
			}
		</style>
		<script type="text/javascript">
		$(document).ready(function() {

			var x = null, y = null;

			function clearTrack()
			{
				x = null, y = null;
				d3.select("#graph").selectAll("svg").remove();
			}

			function drawTrack(data)
			{
				var graph = d3.select("#graph")
					.append("svg:svg")
					.attr("width", "100%")
					.attr("height", "100%");

				var min = { x: 0, y: 0 };
				var max = { x: 0, y: 0 };

				for (d in data.nodes)
				{
					if (data.nodes[d].x > max.x)
						max.x = data.nodes[d].x;

					if (data.nodes[d].x < min.x)
						min.x = data.nodes[d].x;

					if (data.nodes[d].y > max.y)
						max.y = data.nodes[d].y;

					if (data.nodes[d].y < min.y)
						min.y = data.nodes[d].y;
				}

				var height = d3.select("#graph").style('height').replace('px','')-20;

				var scalingfactor = ((max.y-min.y)/height);

				var width = ((max.x-min.x)/scalingfactor);

				d3.select("#graph").style('width', (width+20) + 'px');

				y = d3.scale.linear().domain([min.y, max.y]).range([20, height]);
				x = d3.scale.linear().domain([min.x, max.x]).range([20, width]);

				var line = d3.svg.line()
				.x(function(d,i)
				{
					return x(d.x);
				})
				.y(function(d)
				{
					return y(d.y);
				})
				.interpolate("basis-closed");

				graph.append("svg:path").attr("d", line(data.nodes)).attr("class", "track");

				var title = graph.append("text")
					.attr("class", "title")
					.attr("y", 20)
					.attr("x", 10)
					.text(data.track + ' (resolution: ~' + data.resolution + ')');

				var startfinish = graph.append("svg:rect")
					.attr("x", x(data.startfinish.x)-5)
					.attr("y", y(data.startfinish.y))
					.attr("width", 10)
					.attr("height", 2)
					.style("fill", "#666");
			}

			var getAndDrawTrack = function(trackname)
			{
				d3.json(
					'/static/pth/' + trackname + '.json',
					function (data)
					{
						drawTrack(data);
					}
				);
			}

			var maps = {};
			var players = {};
			var graph = null;

			var socket = io.connect('http://localhost:<%= port.toString() %>');

			socket.on('maps', function (data)
			{
				var select = $('#maps');
				var curr = select.val();

				if (curr > 0)
				{
					if (!data[curr])
						clearTrack();
					else if (data[curr].track != maps[curr].track)
						getAndDrawTrack(data[curr].track);
				}

				for (var i in data)
				{
					if (!maps[i])
					{
						maps[i] = data[i];
						continue;
					}

					for(var j in data[i])
						maps[i][j] = data[i][j];
				}
	
				select.find('option').remove();
				select.append('<option value="" selected="selected">Please select a insim client</option>');

				for(var i in data)
					select.append('<option value="' + i + '">' +
						data[i].hostname + '</option>');
			});

			socket.on('IS_MCI', function (data)
			{
				for(var i in data)
				{
					if (!players[data[i].plid])
						players[data[i].plid] =	d3.select('#graph svg').append("svg:circle")
							.attr("r", 4)
							.attr("class", "player");

					if ($('#fancy').is(':checked'))
					{
						players[data[i].plid]
							.transition()
							.attr("cx", x(data[i].x))
							.attr("cy", y(data[i].y))
							.duration(1000)
							.ease("linear");
					}
					else
					{
						players[data[i].plid]
							.attr("cx", x(data[i].x))
							.attr("cy", y(data[i].y));
					}
				}
			});

			socket.on('IS_PLL', function (data)
			{
				if (players[data])
					players[data].remove();
			});

			$('#maps').change(function()
			{
				var value = $(this).val();

				if ((value.length > 1) && (maps[value] != 'undefined'))
				{
					var track = maps[value].track.replace(/X$/, '');
					getAndDrawTrack(track);

					socket.emit('switch', value);
				}
				else
				{
					players = {};

					console.log('leaving');
					socket.emit('leave');
					clearTrack();
				}
			});
			
		});
		</script>
	</head>
	<body>

		<select id="maps">
		</select>
		<label for="fancy">fancy <input type="checkbox" id="fancy" /></label>

		<div id="graph"></div>

	</body>
</html>
